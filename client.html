<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>M+++</title>
    <style>
        #titulo {
            display: flex;
            justify-content: center;
        }

        #in-ports {
            display: flex;
        }

        .in-port,
        .timer {
            margin: 5px 5px;
        }

        textarea {
            width: 100%;
            height: 500px;
            font-size: 16px;
            resize: none;
        }
    </style>
</head>

<body>
    <div id="titulo">
        <h1>Escreva um código no assembly da M+++ para ser interpretado</h1>
    </div>
    <div id="input">
        <div id="codigo-area">
            <textarea type="text" id="codigo" name="codigo"></textarea>
            <div id="in-ports">
                <div class="in-port">
                    <label for="IN0">IN0</label>
                    <input type="text" value="00" id="IN0" maxlength="2">
                </div>

                <div class="in-port">
                    <label for="IN1">IN1</label>
                    <input type="text" value="00" id="IN1" maxlength="2">
                </div>

                <div class="in-port">
                    <label for="IN2">IN2</label>
                    <input type="text" value="00" id="IN2" maxlength="2">
                </div>

                <div class="in-port">
                    <label for="IN3">IN3</label>
                    <input type="text" value="00" id="IN3" maxlength="2">
                </div>

                <div class="timer">
                    <label for="tempo">Tempo máximo de execução (ss)</label>
                    <input type="number" value="60" min="10" max="1200" id="tempo">
                </div>
            </div>
            <button id="botao" onclick="enviarCodigo()">Enviar</button>
        </div>
    </div>
    <script>
        document.getElementById("codigo").addEventListener('keypress', function (e) {
            const allowedChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVXWYZ;,:";
            if (!allowedChars.includes(e.key.toUpperCase()) && ![32, 13, 10].includes(e.keyCode)) {
                e.preventDefault();
            }
        });

        function INsValidas() {
            const hexRegex = /^[0-9A-Fa-f]+$/;

            for (let i = 0; i < 4; i++) {
                const input = document.getElementById(`IN${i}`).value;
                if (!hexRegex.test(input)) {
                    return false;
                }
            }

            return true;
        }

        function timerValido() {
            let timer = document.getElementById("tempo").value;
            return (timer >= 10 && timer <= 1200);
        }

        function codigoValido() {
            return document.getElementById("codigo").value.trim().length > 0
        }

        function ajustarCodigo() {
            const allowedChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVXWYZ;,: \n";

            let codigo = document.getElementById("codigo").value.toUpperCase();
            codigo = codigo.replace(/\/\/.*/g, '').trim().split('').filter(char => allowedChars.includes(char)).join('');

            return codigo.replaceAll("\n", "_").replaceAll(",", "-").replaceAll(";", ".").replaceAll(":", "*").toUpperCase();
        }

        async function enviarCodigo() {
            var btn = document.getElementById('botao');
            try {
                if (!INsValidas() || !timerValido() || !codigoValido()) {
                    alert("Verifique se todos os campos estão preenchidos de acordo.");
                }
                else {
                    btn.setAttribute('disabled', '');
                    const url = "http://SERVER_IP_AD:8080";
                    const codigo = ajustarCodigo();
                    const in0 = document.getElementById("IN0").value;
                    const in1 = document.getElementById("IN1").value;
                    const in2 = document.getElementById("IN2").value;
                    const in3 = document.getElementById("IN3").value;
                    const timer = document.getElementById("tempo").value;

                    const response = await fetch(url, {
                        method: "POST",
                        body: new URLSearchParams({ timer, in0, in1, in2, in3, codigo }),
                    });

                    if (response.ok) {
                        const text = await response.text();
                        alert(text);
                    } else {
                        if (response.status === 429) {
                            alert("ERRO 429: O servidor está ocupado.");
                        } else {
                            const text = await response.text();
                            alert(`ERRO ${response.status}: ${text}`);
                        }
                    }
                }
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }

            btn.removeAttribute('disabled', '');
        }
    </script>
</body>

</html>