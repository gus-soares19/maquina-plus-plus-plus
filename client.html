<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>M+++</title>
    <style>
        #titulo {display:flex;justify-content:center;}
        #params {display:flex;}
        .params,.timer {margin:5px 5px;}
        textarea {width:100%;height:500px;font-size:16px;resize:none;}
    </style>
</head>
<body>
    <div id="titulo">
        <h1>Escreva um código no assembly da M+++ para ser interpretado</h1>
    </div>
    <div id="input">
        <div id="codigo-area">
            <textarea type="text" id="codigo" name="codigo"></textarea>
            <div id="params">
                <div class="timer">
                    <label for="tempo">Tempo máximo de execução (ss)</label>
                    <input type="number" value="60" min="10" max="1200" id="tempo">
                </div>
                <div class="timer">
                    <label for="tempo">Intervalo entre instruções (ss)</label>
                    <input type="number" value="0" min="0" max="1" id="pausa">
                </div>
            </div>
            <button id="botao" onclick="enviarCodigo()">Enviar</button>
        </div>
    </div>
    <script>
        function timerValido() {
            let timer = document.getElementById("tempo").value;
            let pausa = document.getElementById("pausa").value;
            return (timer >= 10 && timer <= 1200) && (pausa >= 0 && pausa <= 1);
        }
        function codigoValido() {
            return document.getElementById("codigo").value.trim().length > 0
        }
        function ajustarCodigo() {
            const allowedChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVXWYZ;,: \n";
            let codigo = document.getElementById("codigo").value.toUpperCase();
            codigo = codigo.replace(/\/\/.*/g, '').trim().split('').filter(char => allowedChars.includes(char)).join('');
            return codigo.replaceAll("\n", "_").replaceAll(",", "-").replaceAll(";", ".").replaceAll(":", "*").toUpperCase();
        }

        async function enviarCodigo() {
            var btn = document.getElementById('botao');
            try {
                if (!timerValido() || !codigoValido()) {
                    alert("Verifique se todos os campos estão preenchidos de acordo.");
                }
                else {
                    btn.setAttribute('disabled', '');
                    const url = "http://SERVER_IP_AD:8080";
                    const codigo = ajustarCodigo();
                    const timer = document.getElementById("tempo").value;
                    const pausa = document.getElementById("pausa").value;
                    const response = await fetch(url, {
                        method: "POST",
                        body: new URLSearchParams({ timer, codigo, pausa }),
                    });
                    if (response.ok) {
                        const text = await response.text();
                        alert(text);
                    } else {
                        if (response.status === 429) {
                            alert("ERRO 429: O servidor está ocupado.");
                        } else {
                            const text = await response.text();
                            alert(`ERRO ${response.status}: ${text}`);
                        }
                    }
                }
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
            btn.removeAttribute('disabled', '');
        }
    </script>
</body>
</html>